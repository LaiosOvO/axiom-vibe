# 架构总览

## 系统分层

```
┌─────────────────────────────────────────────────┐
│                    客户端层                        │
│  ┌─────────┐  ┌──────────┐  ┌────────────────┐  │
│  │  TUI    │  │ Desktop  │  │ VSCode Plugin  │  │
│  │ (app)   │  │ (Tauri)  │  │  (WebView)     │  │
│  └────┬────┘  └────┬─────┘  └──────┬─────────┘  │
│       └────────────┼───────────────┘             │
│                    ▼                              │
│              ┌──────────┐                        │
│              │   SDK    │                        │
│              │ (fetch)  │                        │
│              └────┬─────┘                        │
├───────────────────┼──────────────────────────────┤
│                   ▼          服务端层             │
│            ┌────────────┐                        │
│            │ HTTP Server│  Hono REST API         │
│            │  (Hono)    │  POST /session/:id/msg │
│            └─────┬──────┘                        │
│                  ▼                                │
│  ┌───────────────────────────────────────────┐   │
│  │              核心引擎                       │   │
│  │  ┌─────────┐ ┌──────────┐ ┌───────────┐  │   │
│  │  │ Session │ │  Agent   │ │   Tool    │  │   │
│  │  │  Loop   │ │ (6 内置) │ │ Registry  │  │   │
│  │  └────┬────┘ └────┬─────┘ └─────┬─────┘  │   │
│  │       └───────────┼─────────────┘         │   │
│  │                   ▼                        │   │
│  │  ┌──────────────────────────────────────┐ │   │
│  │  │           AI Adapter                 │ │   │
│  │  │  generateText / streamText 封装      │ │   │
│  │  └──────────────┬───────────────────────┘ │   │
│  └─────────────────┼────────────────────────-┘   │
│                    ▼                              │
│  ┌──────────────────────────────────────────┐    │
│  │           Provider (15 个)                │    │
│  │ Anthropic │ OpenAI │ Google │ Ollama │... │    │
│  └──────────────────────────────────────────┘    │
├──────────────────────────────────────────────────┤
│                  扩展层                           │
│  ┌──────┐ ┌──────┐ ┌──────────┐ ┌────────────┐  │
│  │ MCP  │ │ LSP  │ │SpecEngine│ │  Research   │  │
│  │Server│ │Server│ │          │ │ + GitHub    │  │
│  └──────┘ └──────┘ └──────────┘ └────────────┘  │
└──────────────────────────────────────────────────┘
```

## 数据流

```
用户输入
  ↓
客户端 (TUI/Desktop/VSCode)
  ↓  HTTP fetch
SDK → POST /session/:id/message
  ↓
HTTP Server (Hono)
  ↓
Session.addMessage()
  ↓
Agent 选择 → AI Adapter
  ↓
Provider → LLM API 调用
  ↓
响应流 → Tool 调用 → 结果返回
  ↓
Session 更新 → 客户端渲染
```

## 技术栈

| 层面 | 技术 | 说明 |
|------|------|------|
| 运行时 | Bun | 高性能 JS/TS 运行时 |
| 语言 | TypeScript (ESM) | 严格类型检查 |
| AI SDK | Vercel AI SDK v5 | generateText/streamText |
| HTTP 框架 | Hono | 轻量高性能 |
| 数据验证 | Zod v4 | Schema 定义 + 运行时验证 |
| TUI 前端 | SolidJS | 细粒度响应式 |
| 桌面应用 | Tauri | 跨平台原生 |
| 测试 | bun:test | 内置测试框架 |
| 构建 | Turborepo | Monorepo 并行构建 |
| 代码规范 | Biome | Lint + Format |

## 设计原则

1. **Namespace 模式** — 所有模块用 TypeScript namespace 组织，无 class
2. **Zod Schema** — 所有数据结构用 Zod 定义，运行时验证
3. **注册表模式** — Provider/Agent/Tool 都用 Map 注册表管理
4. **Client-Server 分离** — 核心引擎是 HTTP 服务，客户端通过 SDK 连接
5. **渐进式扩展** — 内置默认 + 用户自定义注册
